<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Usage Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:        #0d1117;
      --bg-card:   #161b22;
      --bg-hover:  #1c2128;
      --border:    #30363d;
      --text:      #e6edf3;
      --text-dim:  #8b949e;
      --accent:    #58a6ff;
      --green:     #3fb950;
      --yellow:    #d29922;
      --red:       #f85149;
      --purple:    #bc8cff;
      --orange:    #e3b341;
      --mono:      "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    header h1 { font-size: 16px; font-weight: 600; letter-spacing: .3px; }
    header h1 span { color: var(--accent); }
    .header-right { display: flex; align-items: center; gap: 14px; }
    #last-sync { color: var(--text-dim); font-family: var(--mono); font-size: 12px; }
    button#sync-btn {
      background: var(--accent);
      color: #0d1117;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }
    button#sync-btn:hover   { opacity: .85; }
    button#sync-btn:disabled { opacity: .5; cursor: not-allowed; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main { padding: 24px; max-width: 1400px; margin: 0 auto; }
    section { margin-bottom: 28px; }
    h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--text-dim);
      margin-bottom: 12px;
      font-weight: 600;
    }

    /* â”€â”€ Summary Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px 20px;
    }
    .card-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: .6px; margin-bottom: 8px; }
    .card-value { font-family: var(--mono); font-size: 26px; font-weight: 700; color: var(--accent); }
    .card-sub   { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

    /* â”€â”€ Chart cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px 20px;
    }
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chart-title { font-size: 14px; font-weight: 600; color: var(--text); }
    .week-nav { display: flex; align-items: center; gap: 10px; }
    .week-nav button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 5px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s;
    }
    .week-nav button:hover:not(:disabled) { background: var(--bg-hover); }
    .week-nav button:disabled { opacity: .35; cursor: not-allowed; }
    #week-label { font-family: var(--mono); font-size: 12px; color: var(--text-dim); min-width: 120px; text-align: center; }
    .chart-wrap { position: relative; height: 260px; }

    /* â”€â”€ Token type toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .token-type-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .token-type-toggle label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-right: 4px;
    }
    .token-type-toggle button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-dim);
      border-radius: 5px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all .15s;
    }
    .token-type-toggle button:hover { background: var(--bg-hover); color: var(--text); }
    .token-type-toggle button.active {
      background: rgba(88,166,255,.15);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 600;
    }

    /* â”€â”€ Hourly section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #hourly-section { display: none; }
    .back-link {
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      background: none;
      border: none;
      padding: 0;
    }
    .back-link:hover { opacity: .75; }

    /* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th {
      text-align: left;
      padding: 10px 14px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--bg-hover); }
    td.text { font-family: inherit; font-size: 13px; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      font-family: inherit;
    }
    .badge-cfg      { background: rgba(88,166,255,.12); color: var(--accent); }
    .badge-nocfg    { background: rgba(139,148,158,.12); color: var(--text-dim); }
    .badge-nocapture{ background: rgba(227,179,65,.12); color: var(--orange); }
    .provider-note  { font-size: 10px; color: var(--text-dim); margin-top: 4px; max-width: 160px; line-height: 1.3; }

    /* â”€â”€ Provider grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .provider-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .provider-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .provider-name   { font-size: 13px; font-weight: 500; }
    .provider-method { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

    /* â”€â”€ Pricing Config Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pricing-toggle-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s;
    }
    .pricing-toggle-btn:hover { background: var(--bg-hover); }
    .pricing-config-body {
      overflow: hidden;
      max-height: 0;
      transition: max-height .4s ease;
    }
    .pricing-config-body.open { max-height: 3000px; }
    .pricing-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 4px 6px;
      font-family: var(--mono);
      font-size: 12px;
      width: 80px;
    }
    .pricing-input:focus { outline: none; border-color: var(--accent); }
    .pricing-save-btn {
      background: rgba(88,166,255,.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap;
    }
    .pricing-save-btn:hover { background: rgba(88,166,255,.25); }
    .pricing-save-ok {
      color: var(--green);
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
      display: none;
    }
    .add-model-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      padding: 16px 14px;
      border-top: 1px solid var(--border);
    }
    .add-model-form label { font-size: 11px; color: var(--text-dim); display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: .4px; }
    .add-model-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 13px;
      width: 140px;
    }
    .add-model-input.narrow { width: 90px; }
    .add-model-input:focus { outline: none; border-color: var(--accent); }
    .add-model-btn {
      background: var(--accent);
      color: #0d1117;
      border: none;
      border-radius: 4px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }
    .add-model-btn:hover { opacity: .85; }

    /* â”€â”€ Current Session Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .session-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px 22px;
    }
    .session-card.warning {
      border-color: var(--orange);
      box-shadow: 0 0 0 1px rgba(227,179,65,.3);
    }
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 6px;
    }
    .session-title {
      font-size: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .session-started {
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--mono);
    }
    .session-row {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      margin-bottom: 6px;
    }
    .session-row .sep { color: var(--border); margin: 0 6px; }
    .session-cost { color: var(--accent); font-weight: 700; }
    .session-cost.warn { color: var(--orange); }
    .session-tokens { color: var(--text-dim); font-size: 12px; }
    .session-progress-wrap {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .session-progress-bar {
      flex: 1;
      min-width: 120px;
      height: 8px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .session-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .4s ease;
      background: var(--green);
    }
    .session-progress-fill.warn { background: var(--orange); }
    .session-progress-fill.over { background: var(--red); }
    .session-progress-label {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
    }
    .session-warning-badge {
      font-size: 12px;
      font-weight: 700;
      color: var(--orange);
      display: none;
    }
    .session-inactive {
      color: var(--text-dim);
      font-size: 13px;
      padding: 6px 0;
    }

    /* â”€â”€ Alert Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .alert-settings-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .alert-settings-label { font-size: 12px; color: var(--text-dim); }
    .alert-threshold-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: var(--mono);
      font-size: 13px;
      width: 90px;
    }
    .alert-threshold-input:focus { outline: none; border-color: var(--accent); }
    .alert-save-btn {
      background: rgba(88,166,255,.15);
      border: 1px solid var(--accent);
      color: var(--accent);
      border-radius: 4px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s;
    }
    .alert-save-btn:hover { background: rgba(88,166,255,.25); }
    .alert-save-ok {
      color: var(--green);
      font-size: 11px;
      font-weight: 600;
      display: none;
    }
    .whatsapp-settings-block {
      padding: 14px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .whatsapp-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .whatsapp-text-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 4px;
      padding: 4px 8px;
      font-family: var(--mono);
      font-size: 13px;
      flex: 1;
      min-width: 160px;
      max-width: 340px;
    }
    .whatsapp-text-input:focus { outline: none; border-color: var(--accent); }
    .whatsapp-toggle {
      appearance: none;
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      transition: background .2s;
      flex-shrink: 0;
    }
    .whatsapp-toggle::after {
      content: '';
      position: absolute;
      top: 3px; left: 3px;
      width: 14px; height: 14px;
      background: #fff;
      border-radius: 50%;
      transition: left .2s;
    }
    .whatsapp-toggle:checked { background: var(--green); }
    .whatsapp-toggle:checked::after { left: 19px; }
    .alert-test-btn {
      background: rgba(63,185,80,.15);
      border: 1px solid var(--green);
      color: var(--green);
      border-radius: 4px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s;
    }
    .alert-test-btn:hover { background: rgba(63,185,80,.25); }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(10px);
      transition: all .25s;
      pointer-events: none;
      z-index: 999;
      max-width: 340px;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok  { border-color: var(--green); color: var(--green); }
    #toast.err { border-color: var(--red);   color: var(--red); }
  </style>
</head>
<body>

<header>
  <h1>OpenClaw <span>Usage Dashboard</span></h1>
  <div class="header-right">
    <span id="last-sync">Last sync: â€”</span>
    <button id="sync-btn" onclick="triggerSync()">â†» Sync Now</button>
  </div>
</header>

<main>

  <!-- Current Session Monitor -->
  <section id="current-session-section">
    <h2>âš¡ Current Session</h2>
    <div class="session-card" id="session-card">
      <div class="session-inactive" id="session-loading">Loadingâ€¦</div>
    </div>
  </section>

  <!-- Summary Cards -->
  <section>
    <h2>Overview â€” Last 7 Days</h2>
    <div class="cards">
      <div class="card">
        <div class="card-label">Real Tokens (7d)</div>
        <div class="card-value" id="c-real-7d">â€”</div>
        <div class="card-sub">Input + Output only</div>
      </div>
      <div class="card">
        <div class="card-label">Cache Tokens (7d)</div>
        <div class="card-value" id="c-cache-7d">â€”</div>
        <div class="card-sub">Cache reads (not billed)</div>
      </div>
      <div class="card">
        <div class="card-label">Requests (7d)</div>
        <div class="card-value" id="c-req-7d">â€”</div>
      </div>
      <div class="card">
        <div class="card-label">Est. Cost (30d)</div>
        <div class="card-value" id="c-cost-30d">â€”</div>
        <div class="card-sub">Real pricing applied (Anthropic + Kimi)</div>
      </div>
    </div>
  </section>

  <!-- Weekly Chart -->
  <section id="weekly-section">
    <h2>Weekly Token Usage</h2>
    <div class="chart-card">
      <div class="chart-header">
        <div class="week-nav">
          <button id="btn-prev-week" onclick="navigateWeek(-1)">â† Prev</button>
          <span id="week-label">â€”</span>
          <button id="btn-next-week" onclick="navigateWeek(1)">Next â†’</button>
        </div>
        <div class="token-type-toggle">
          <label>Token type:</label>
          <button id="tt-input"       onclick="setTokenType('input')">Input</button>
          <button id="tt-output"      onclick="setTokenType('output')" class="active">Output</button>
          <button id="tt-cache_read"  onclick="setTokenType('cache_read')">Cache Read</button>
          <button id="tt-cache_write" onclick="setTokenType('cache_write')">Cache Write</button>
        </div>
      </div>
      <div class="chart-wrap"><canvas id="chart-weekly"></canvas></div>
    </div>
  </section>

  <!-- Hourly Chart (hidden until a day bar is clicked) -->
  <section id="hourly-section">
    <h2>Hourly Breakdown â€” <span id="hourly-date-label">â€”</span></h2>
    <div class="chart-card">
      <div class="chart-header">
        <button class="back-link" onclick="hideHourly()">â† Back to week</button>
      </div>
      <div class="chart-wrap"><canvas id="chart-hourly"></canvas></div>
    </div>
  </section>

  <!-- Model Breakdown Table -->
  <section>
    <h2>Breakdown by Model â€” Last 30 Days</h2>
    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th>Provider</th>
            <th>Model</th>
            <th>Output</th>
            <th>Input</th>
            <th>Cache Read</th>
            <th>Cache Write</th>
            <th>Requests</th>
            <th>Est. Cost (USD)</th>
          </tr>
        </thead>
        <tbody id="model-table-body">
          <tr><td colspan="8" class="text" style="color:var(--text-dim);padding:20px">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Provider Status -->
  <section>
    <h2>Provider Status</h2>
    <div class="provider-grid" id="provider-grid">Loadingâ€¦</div>
  </section>

  <!-- Pricing Config (collapsed by default) -->
  <section>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
      <h2 style="margin-bottom:0">âš™ Pricing Config</h2>
      <button class="pricing-toggle-btn" onclick="togglePricingPanel()">
        <span id="pricing-toggle-icon">â–¼</span> Edit Prices
      </button>
    </div>
    <div class="pricing-config-body" id="pricing-config-body">
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>Model ID</th>
              <th>Display Name</th>
              <th>Input $/M</th>
              <th>Output $/M</th>
              <th>Cache Read $/M</th>
              <th>Cache Write $/M</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pricing-table-body">
            <tr><td colspan="7" class="text" style="color:var(--text-dim);padding:20px">Click "Edit Prices" to expand.</td></tr>
          </tbody>
        </table>
        <div class="add-model-form">
          <div>
            <label>Model ID</label>
            <input type="text" class="add-model-input" id="add-model-id" placeholder="e.g. gpt-4o" />
          </div>
          <div>
            <label>Display Name</label>
            <input type="text" class="add-model-input" id="add-model-name" placeholder="e.g. GPT-4o" />
          </div>
          <div>
            <label>Input $/M</label>
            <input type="number" class="add-model-input narrow" id="add-model-inp" step="0.001" min="0" value="0" />
          </div>
          <div>
            <label>Output $/M</label>
            <input type="number" class="add-model-input narrow" id="add-model-out" step="0.001" min="0" value="0" />
          </div>
          <div>
            <label>Cache Read $/M</label>
            <input type="number" class="add-model-input narrow" id="add-model-cr" step="0.001" min="0" value="0" />
          </div>
          <div>
            <label>Cache Write $/M</label>
            <input type="number" class="add-model-input narrow" id="add-model-cw" step="0.001" min="0" value="0" />
          </div>
          <button class="add-model-btn" onclick="addModel()">+ Add Model</button>
        </div>

        <!-- Alert Settings -->
        <div class="alert-settings-row">
          <span class="alert-settings-label">ğŸ”” Session cost warning threshold:</span>
          <input type="number" class="alert-threshold-input" id="alert-threshold" step="0.5" min="0" value="5.00" />
          <span class="alert-settings-label">USD</span>
          <button class="alert-save-btn" onclick="saveAlertThreshold()">Save</button>
          <span class="alert-save-ok" id="alert-save-ok">âœ“ Saved</span>
        </div>

        <!-- WhatsApp Alert Settings -->
        <div class="whatsapp-settings-block">
          <div class="whatsapp-row">
            <span class="alert-settings-label">ğŸ’¬ WhatsApp alerts:</span>
            <input type="checkbox" class="whatsapp-toggle" id="wa-enabled" onchange="saveWhatsAppSettings()" />
            <span class="alert-settings-label" id="wa-enabled-label">Disabled</span>
          </div>
          <div class="whatsapp-row">
            <span class="alert-settings-label">Send to:</span>
            <input type="text" class="whatsapp-text-input" id="wa-to" placeholder="+351910298749" style="max-width:200px;" />
          </div>
          <div class="whatsapp-row">
            <button class="alert-save-btn" onclick="saveWhatsAppSettings()">Save</button>
            <button class="alert-test-btn" onclick="testWhatsAppAlert()">ğŸ”” Test Alert</button>
            <span class="alert-save-ok" id="wa-save-ok">âœ“ Saved</span>
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<div id="toast"></div>

<script>
/* â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const fmt = n => n == null ? 'â€”' : Number(n).toLocaleString('en-US');
const fmtK = n => {
  if (n == null) return 'â€”';
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
  if (n >= 1_000)     return (n / 1_000).toFixed(1) + 'K';
  return String(n);
};
const fmtCost = v => v == null ? 'â€”' : '$' + Number(v).toFixed(4);

/* â”€â”€ Chart defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
Chart.defaults.color = '#8b949e';
Chart.defaults.borderColor = '#30363d';
Chart.defaults.font.family = 'inherit';

let chartWeekly = null;
let chartHourly = null;

/* â”€â”€ Model color palette (consistent by model name across week changes) â”€â”€â”€ */
const MODEL_COLORS = [
  '#4e9af1', // blue
  '#f17c4e', // orange
  '#4ef1a0', // green
  '#f1e44e', // yellow
  '#c04ef1', // purple
  '#f14e7c', // red
];
// Map model name â†’ color (assigned on first encounter, stable across calls)
const modelColorMap = {};
let modelColorIdx = 0;
function colorForModel(model) {
  if (!(model in modelColorMap)) {
    modelColorMap[model] = MODEL_COLORS[modelColorIdx % MODEL_COLORS.length];
    modelColorIdx++;
  }
  return modelColorMap[model];
}

/* â”€â”€ Week state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentWeekOffset = 0;
let currentWeekData = null;   // cached days array for label lookup
let currentTokenType = 'output';  // default token type for weekly chart

const TOKEN_TYPE_LABELS = {
  input:       'Input Tokens',
  output:      'Output Tokens',
  cache_read:  'Cache Read Tokens',
  cache_write: 'Cache Write Tokens',
};

function setTokenType(type) {
  currentTokenType = type;
  // Update toggle button styles
  ['input', 'output', 'cache_read', 'cache_write'].forEach(t => {
    const btn = document.getElementById('tt-' + t);
    if (btn) btn.classList.toggle('active', t === type);
  });
  loadWeekly(currentWeekOffset);
}

function weekLabel(weekStart) {
  const d = new Date(weekStart + 'T00:00:00Z');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
}

function dayLabel(dateStr) {
  const d = new Date(dateStr + 'T00:00:00Z');
  const day = d.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
  const num = d.getUTCDate();
  return `${day} ${num}`;
}

function buildWeeklyChart(weekData) {
  currentWeekData = weekData.days;

  const labels = weekData.days.map(d => dayLabel(d.date));
  const tokenType = weekData.token_type || currentTokenType;
  const yAxisLabel = TOKEN_TYPE_LABELS[tokenType] || 'Tokens';

  // Update nav label
  document.getElementById('week-label').textContent =
    'Week of ' + weekLabel(weekData.week_start);

  // Disable next-week button if already on current week
  document.getElementById('btn-next-week').disabled = currentWeekOffset >= 0;

  // Pre-assign colors to all models now so they are consistent
  weekData.models.forEach(m => colorForModel(m));

  const datasets = weekData.models.map(model => {
    const color = colorForModel(model);
    return {
      label: model,
      data: weekData.days.map(d => (d.by_model && d.by_model[model]) || 0),
      backgroundColor: color + 'aa',
      borderColor: color,
      borderWidth: 1,
      borderRadius: 2,
    };
  });

  if (chartWeekly) chartWeekly.destroy();
  chartWeekly = new Chart(document.getElementById('chart-weekly'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: { boxWidth: 12, font: { size: 11 }, padding: 10 }
        }
      },
      scales: {
        x: { stacked: true, ticks: { font: { size: 11 } } },
        y: {
          stacked: true,
          ticks: { callback: v => fmtK(v) },
          title: { display: true, text: yAxisLabel, color: '#8b949e', font: { size: 11 } }
        }
      },
      onClick: (evt, elements) => {
        if (!elements.length) return;
        const idx = elements[0].index;
        const day = weekData.days[idx];
        loadHourly(day.date);
      }
    }
  });
}

async function navigateWeek(delta) {
  currentWeekOffset += delta;
  await loadWeekly(currentWeekOffset);
}

/* â”€â”€ Hourly chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadHourly(dateStr) {
  const data = await fetch('/api/usage/hourly?date=' + dateStr).then(r => r.json());

  // Update title
  const d = new Date(dateStr + 'T00:00:00Z');
  const label = d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', timeZone: 'UTC' });
  document.getElementById('hourly-date-label').textContent = label;
  document.getElementById('hourly-section').style.display = 'block';

  const labels = data.hours.map(h => String(h.hour).padStart(2, '0') + 'h');
  const values = data.hours.map(h => h.real_tokens);

  if (chartHourly) chartHourly.destroy();
  chartHourly = new Chart(document.getElementById('chart-hourly'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Real Tokens',
        data: values,
        backgroundColor: 'rgba(188,140,255,.55)',
        borderColor: '#bc8cff',
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { font: { size: 11 } } },
        y: { ticks: { callback: v => fmtK(v) } }
      }
    }
  });

  // Scroll to hourly section
  document.getElementById('hourly-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideHourly() {
  document.getElementById('hourly-section').style.display = 'none';
  if (chartHourly) { chartHourly.destroy(); chartHourly = null; }
}

/* â”€â”€ Data loaders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSummary() {
  const r = await fetch('/api/usage/summary').then(r => r.json());
  const s7 = r.by_period.last_7d;
  const s30 = r.by_period.last_30d;

  document.getElementById('c-real-7d').textContent  = fmtK(s7.real_tokens);
  document.getElementById('c-req-7d').textContent   = fmt(s7.requests);
  document.getElementById('c-cost-30d').textContent = fmtCost(r.estimated_cost_usd);

  // Cache is a 30d total from summary; show proportionally is tricky â€” use total
  document.getElementById('c-cache-7d').textContent = fmtK(r.total_cache_tokens);

  return r;
}

async function loadWeekly(offset) {
  const url = `/api/usage/weekly-by-model?week_offset=${offset}&token_type=${currentTokenType}`;
  const data = await fetch(url).then(r => r.json());
  buildWeeklyChart(data);
}

async function loadModelTable() {
  const data = await fetch('/api/usage/by-model').then(r => r.json());
  const tbody = document.getElementById('model-table-body');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="text" style="color:var(--text-dim);padding:20px">No data yet â€” run a sync.</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(d => `
    <tr>
      <td class="text">${d.provider}</td>
      <td class="text">${d.model}</td>
      <td>${fmt(d.output_tokens)}</td>
      <td>${fmt(d.input_tokens)}</td>
      <td>${fmt(d.cache_read_tokens)}</td>
      <td>${fmt(d.cache_write_tokens)}</td>
      <td>${fmt(d.request_count)}</td>
      <td>${fmtCost(d.estimated_cost_usd)}</td>
    </tr>`).join('');
}

async function loadProviders() {
  const data = await fetch('/api/providers').then(r => r.json());
  const grid = document.getElementById('provider-grid');
  grid.innerHTML = data.map(p => {
    const isGemini = p.name === 'google';
    const badge = isGemini
      ? `<div style="text-align:right">
           <span class="badge badge-nocapture">Not captured</span>
           <div class="provider-note">Gemini is used for heartbeats only â€” heartbeat calls are not recorded in session files.</div>
         </div>`
      : `<span class="badge ${p.is_configured ? 'badge-cfg' : 'badge-nocfg'}">
           ${p.is_configured ? 'Configured' : 'Not configured'}
         </span>`;
    return `
    <div class="provider-card">
      <div>
        <div class="provider-name">${p.display_name}</div>
        <div class="provider-method">${p.method}</div>
      </div>
      ${badge}
    </div>`;
  }).join('');
}

async function loadSyncLog() {
  const data = await fetch('/api/sync/log').then(r => r.json());
  if (data[0]) {
    document.getElementById('last-sync').textContent = 'Last sync: ' + data[0].synced_at;
  }
}

/* â”€â”€ Sync trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function triggerSync() {
  const btn = document.getElementById('sync-btn');
  btn.disabled = true;
  btn.textContent = 'â†» Syncingâ€¦';
  try {
    const r = await fetch('/api/sync', { method: 'POST' }).then(r => r.json());
    showToast(r.message, 'ok');
    await loadAll();
  } catch (e) {
    showToast('Sync failed: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'â†» Sync Now';
  }
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let toastTimer;
function showToast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 4000);
}

/* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadAll() {
  currentWeekOffset = 0;
  await Promise.all([
    loadCurrentSession(),
    loadSummary(),
    loadWeekly(0),
    loadModelTable(),
    loadProviders(),
    loadSyncLog(),
    loadAlertThreshold(),
  ]);
}

loadAll();

/* â”€â”€ Pricing Config Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let pricingPanelOpen = false;

function togglePricingPanel() {
  pricingPanelOpen = !pricingPanelOpen;
  const body = document.getElementById('pricing-config-body');
  const icon = document.getElementById('pricing-toggle-icon');
  body.classList.toggle('open', pricingPanelOpen);
  icon.textContent = pricingPanelOpen ? 'â–²' : 'â–¼';
  if (pricingPanelOpen) loadPricingTable();
}

function escHtml(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

async function loadPricingTable() {
  const data = await fetch('/api/pricing').then(r => r.json());
  const tbody = document.getElementById('pricing-table-body');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="text" style="color:var(--text-dim);padding:20px">No pricing configured.</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(p => {
    const esc = CSS.escape(p.model);
    return `
    <tr id="price-row-${esc}">
      <td class="text" style="max-width:160px;word-break:break-all">${escHtml(p.model)}</td>
      <td><input type="text" class="pricing-input" style="width:140px" id="pr-name-${esc}" value="${escHtml(p.display_name || p.model)}" /></td>
      <td><input type="number" class="pricing-input" step="0.001" min="0" id="pr-inp-${esc}" value="${p.input_per_m}" /></td>
      <td><input type="number" class="pricing-input" step="0.001" min="0" id="pr-out-${esc}" value="${p.output_per_m}" /></td>
      <td><input type="number" class="pricing-input" step="0.001" min="0" id="pr-cr-${esc}" value="${p.cache_read_per_m}" /></td>
      <td><input type="number" class="pricing-input" step="0.001" min="0" id="pr-cw-${esc}" value="${p.cache_write_per_m}" /></td>
      <td style="white-space:nowrap">
        <button class="pricing-save-btn" onclick="savePricing(${JSON.stringify(p.model)})">Save</button>
        <span class="pricing-save-ok" id="pr-ok-${esc}">âœ“ Saved</span>
      </td>
    </tr>`;
  }).join('');
}

async function savePricing(model) {
  const esc = CSS.escape(model);
  const displayName = document.getElementById(`pr-name-${esc}`)?.value || model;
  const inp = parseFloat(document.getElementById(`pr-inp-${esc}`)?.value || 0);
  const out = parseFloat(document.getElementById(`pr-out-${esc}`)?.value || 0);
  const cr  = parseFloat(document.getElementById(`pr-cr-${esc}`)?.value  || 0);
  const cw  = parseFloat(document.getElementById(`pr-cw-${esc}`)?.value  || 0);
  try {
    await fetch(`/api/pricing/${encodeURIComponent(model)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ display_name: displayName, input_per_m: inp, output_per_m: out, cache_read_per_m: cr, cache_write_per_m: cw }),
    });
    const okEl = document.getElementById(`pr-ok-${esc}`);
    if (okEl) { okEl.style.display = 'inline'; setTimeout(() => { okEl.style.display = 'none'; }, 2500); }
    await Promise.all([loadSummary(), loadModelTable()]);
  } catch (e) {
    showToast('Save failed: ' + e.message, 'err');
  }
}

/* â”€â”€ Current Session Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function fmtDuration(minutes) {
  if (minutes < 60) return `${minutes}m`;
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return m > 0 ? `${h}h ${m}m` : `${h}h`;
}

async function loadCurrentSession() {
  const card = document.getElementById('session-card');
  try {
    const data = await fetch('/api/session/current').then(r => r.json());

    if (data.status === 'no_active_session') {
      card.classList.remove('warning');
      card.innerHTML = '<div class="session-inactive">No active session detected.</div>';
      return;
    }

    const warning = data.warning;
    card.classList.toggle('warning', warning);

    const threshold = data.warning_threshold_usd || 5.0;
    const cost = data.estimated_cost_usd || 0;
    const ratio = threshold > 0 ? Math.min(cost / threshold, 2) : 0;  // cap at 2Ã—
    const pct = Math.min(ratio * 100, 100);
    const fillClass = cost >= threshold ? 'over' : (pct > 70 ? 'warn' : '');
    const costClass = warning ? 'session-cost warn' : 'session-cost';

    const models = (data.models_used || []).join(', ') || 'â€”';
    const dur = fmtDuration(data.duration_minutes || 0);

    card.innerHTML = `
      <div class="session-header">
        <div class="session-title">
          Session <span style="color:var(--text-dim);font-size:12px;font-weight:400;font-family:var(--mono)">${data.session_id}</span>
        </div>
        <div class="session-started">started ${dur} ago</div>
      </div>
      <div class="session-row">
        <span>${fmtK(data.message_count)} messages</span>
        <span class="sep">|</span>
        <span>${escHtml(models)}</span>
        <span class="sep">|</span>
        Est. cost: <span class="${costClass}">${fmtCost(cost)}</span>
        ${warning ? '<span class="session-warning-badge" style="display:inline">âš ï¸ Over threshold</span>' : ''}
      </div>
      <div class="session-tokens">
        In: ${fmtK(data.input_tokens)}&nbsp;&nbsp;
        Out: ${fmtK(data.output_tokens)}&nbsp;&nbsp;
        Cache Read: ${fmtK(data.cache_read_tokens)}&nbsp;&nbsp;
        Cache Write: ${fmtK(data.cache_write_tokens)}
      </div>
      <div class="session-progress-wrap">
        <div class="session-progress-bar">
          <div class="session-progress-fill ${fillClass}" style="width:${pct.toFixed(1)}%"></div>
        </div>
        <span class="session-progress-label">${fmtCost(cost)} / ${fmtCost(threshold)} threshold</span>
      </div>`;
  } catch (e) {
    card.innerHTML = `<div class="session-inactive" style="color:var(--red)">Error loading session: ${e.message}</div>`;
  }
}

// Auto-refresh every 60 seconds
setInterval(loadCurrentSession, 60_000);

/* â”€â”€ Alert Threshold Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveAlertThreshold() {
  const val = parseFloat(document.getElementById('alert-threshold').value);
  if (isNaN(val) || val < 0) { showToast('Invalid threshold value', 'err'); return; }
  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_cost_warning_usd: val }),
    });
    const okEl = document.getElementById('alert-save-ok');
    if (okEl) { okEl.style.display = 'inline'; setTimeout(() => { okEl.style.display = 'none'; }, 2500); }
    // Re-render the session widget with the new threshold
    await loadCurrentSession();
  } catch (e) {
    showToast('Save failed: ' + e.message, 'err');
  }
}

async function loadAlertThreshold() {
  try {
    const data = await fetch('/api/settings').then(r => r.json());
    const threshold = data.session_cost_warning_usd;
    if (threshold !== undefined) {
      document.getElementById('alert-threshold').value = parseFloat(threshold).toFixed(2);
    }
    // Load WhatsApp settings
    const enabled = data.alert_whatsapp_enabled === 'true';
    const waToggle = document.getElementById('wa-enabled');
    const waLabel  = document.getElementById('wa-enabled-label');
    if (waToggle) {
      waToggle.checked = enabled;
      waLabel.textContent = enabled ? 'Enabled' : 'Disabled';
    }
    const waTo = data.alert_whatsapp_to || '';
    const waToInput = document.getElementById('wa-to');
    if (waToInput && waTo) waToInput.value = waTo;
  } catch (_) {}
}

async function saveWhatsAppSettings() {
  const enabled = document.getElementById('wa-enabled').checked;
  const to      = document.getElementById('wa-to').value.trim();
  const waLabel = document.getElementById('wa-enabled-label');

  const payload = { alert_whatsapp_enabled: enabled ? 'true' : 'false' };
  if (to) payload.alert_whatsapp_to = to;

  try {
    await fetch('/api/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    waLabel.textContent = enabled ? 'Enabled' : 'Disabled';
    const okEl = document.getElementById('wa-save-ok');
    if (okEl) { okEl.style.display = 'inline'; setTimeout(() => { okEl.style.display = 'none'; }, 2500); }
  } catch (e) {
    showToast('Save failed: ' + e.message, 'err');
  }
}

async function testWhatsAppAlert() {
  try {
    const r = await fetch('/api/alerts/test', { method: 'POST' });
    const data = await r.json();
    if (r.ok) {
      showToast('Test alert sent âœ“', 'ok');
    } else {
      showToast('Test failed: ' + (data.detail || r.statusText), 'err');
    }
  } catch (e) {
    showToast('Test failed: ' + e.message, 'err');
  }
}

async function addModel() {
  const model = document.getElementById('add-model-id').value.trim();
  const displayName = document.getElementById('add-model-name').value.trim() || model;
  const inp = parseFloat(document.getElementById('add-model-inp').value || 0);
  const out = parseFloat(document.getElementById('add-model-out').value || 0);
  const cr  = parseFloat(document.getElementById('add-model-cr').value  || 0);
  const cw  = parseFloat(document.getElementById('add-model-cw').value  || 0);
  if (!model) { showToast('Model ID is required', 'err'); return; }
  try {
    const r = await fetch(`/api/pricing/${encodeURIComponent(model)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ display_name: displayName, input_per_m: inp, output_per_m: out, cache_read_per_m: cr, cache_write_per_m: cw }),
    });
    if (!r.ok) throw new Error(await r.text());
    // Clear form
    document.getElementById('add-model-id').value = '';
    document.getElementById('add-model-name').value = '';
    ['add-model-inp','add-model-out','add-model-cr','add-model-cw'].forEach(id => { document.getElementById(id).value = 0; });
    showToast('Model added âœ“', 'ok');
    await loadPricingTable();
    await Promise.all([loadSummary(), loadModelTable()]);
  } catch (e) {
    showToast('Add failed: ' + e.message, 'err');
  }
}
</script>
</body>
</html>
