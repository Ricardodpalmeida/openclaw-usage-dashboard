<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Usage Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:        #0d1117;
      --bg-card:   #161b22;
      --bg-hover:  #1c2128;
      --border:    #30363d;
      --text:      #e6edf3;
      --text-dim:  #8b949e;
      --accent:    #58a6ff;
      --green:     #3fb950;
      --yellow:    #d29922;
      --red:       #f85149;
      --purple:    #bc8cff;
      --orange:    #e3b341;
      --mono:      "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
    }

    /* ── Header ─────────────────────────────────────────────────────────── */
    header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    header h1 { font-size: 16px; font-weight: 600; letter-spacing: .3px; }
    header h1 span { color: var(--accent); }
    .header-right { display: flex; align-items: center; gap: 14px; }
    #last-sync { color: var(--text-dim); font-family: var(--mono); font-size: 12px; }
    button#sync-btn {
      background: var(--accent);
      color: #0d1117;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }
    button#sync-btn:hover   { opacity: .85; }
    button#sync-btn:disabled { opacity: .5; cursor: not-allowed; }

    /* ── Layout ─────────────────────────────────────────────────────────── */
    main { padding: 24px; max-width: 1400px; margin: 0 auto; }
    section { margin-bottom: 28px; }
    h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--text-dim);
      margin-bottom: 12px;
      font-weight: 600;
    }

    /* ── Summary Cards ───────────────────────────────────────────────────── */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px 20px;
    }
    .card-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: .6px; margin-bottom: 8px; }
    .card-value { font-family: var(--mono); font-size: 26px; font-weight: 700; color: var(--accent); }
    .card-sub   { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

    /* ── Chart cards ─────────────────────────────────────────────────────── */
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 18px 20px;
    }
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chart-title { font-size: 14px; font-weight: 600; color: var(--text); }
    .week-nav { display: flex; align-items: center; gap: 10px; }
    .week-nav button {
      background: none;
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 5px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background .15s;
    }
    .week-nav button:hover:not(:disabled) { background: var(--bg-hover); }
    .week-nav button:disabled { opacity: .35; cursor: not-allowed; }
    #week-label { font-family: var(--mono); font-size: 12px; color: var(--text-dim); min-width: 120px; text-align: center; }
    .chart-wrap { position: relative; height: 260px; }

    /* ── Hourly section ──────────────────────────────────────────────────── */
    #hourly-section { display: none; }
    .back-link {
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      text-decoration: underline;
      background: none;
      border: none;
      padding: 0;
    }
    .back-link:hover { opacity: .75; }

    /* ── Tables ──────────────────────────────────────────────────────────── */
    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th {
      text-align: left;
      padding: 10px 14px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 12px;
      white-space: nowrap;
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: var(--bg-hover); }
    td.text { font-family: inherit; font-size: 13px; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      font-family: inherit;
    }
    .badge-cfg      { background: rgba(88,166,255,.12); color: var(--accent); }
    .badge-nocfg    { background: rgba(139,148,158,.12); color: var(--text-dim); }
    .badge-nocapture{ background: rgba(227,179,65,.12); color: var(--orange); }
    .provider-note  { font-size: 10px; color: var(--text-dim); margin-top: 4px; max-width: 160px; line-height: 1.3; }

    /* ── Provider grid ───────────────────────────────────────────────────── */
    .provider-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .provider-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .provider-name   { font-size: 13px; font-weight: 500; }
    .provider-method { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

    /* ── Toast ───────────────────────────────────────────────────────────── */
    #toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 18px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(10px);
      transition: all .25s;
      pointer-events: none;
      z-index: 999;
      max-width: 340px;
    }
    #toast.show { opacity: 1; transform: translateY(0); }
    #toast.ok  { border-color: var(--green); color: var(--green); }
    #toast.err { border-color: var(--red);   color: var(--red); }
  </style>
</head>
<body>

<header>
  <h1>OpenClaw <span>Usage Dashboard</span></h1>
  <div class="header-right">
    <span id="last-sync">Last sync: —</span>
    <button id="sync-btn" onclick="triggerSync()">↻ Sync Now</button>
  </div>
</header>

<main>

  <!-- Summary Cards -->
  <section>
    <h2>Overview — Last 7 Days</h2>
    <div class="cards">
      <div class="card">
        <div class="card-label">Real Tokens (7d)</div>
        <div class="card-value" id="c-real-7d">—</div>
        <div class="card-sub">Input + Output only</div>
      </div>
      <div class="card">
        <div class="card-label">Cache Tokens (7d)</div>
        <div class="card-value" id="c-cache-7d">—</div>
        <div class="card-sub">Cache reads (not billed)</div>
      </div>
      <div class="card">
        <div class="card-label">Requests (7d)</div>
        <div class="card-value" id="c-req-7d">—</div>
      </div>
      <div class="card">
        <div class="card-label">Est. Cost (30d)</div>
        <div class="card-value" id="c-cost-30d">—</div>
        <div class="card-sub">Real pricing applied (Anthropic + Kimi)</div>
      </div>
    </div>
  </section>

  <!-- Weekly Chart -->
  <section id="weekly-section">
    <h2>Weekly Token Usage</h2>
    <div class="chart-card">
      <div class="chart-header">
        <div class="week-nav">
          <button id="btn-prev-week" onclick="navigateWeek(-1)">← Prev</button>
          <span id="week-label">—</span>
          <button id="btn-next-week" onclick="navigateWeek(1)">Next →</button>
        </div>
        <span class="chart-title" id="weekly-title">Daily Real Tokens</span>
      </div>
      <div class="chart-wrap"><canvas id="chart-weekly"></canvas></div>
    </div>
  </section>

  <!-- Hourly Chart (hidden until a day bar is clicked) -->
  <section id="hourly-section">
    <h2>Hourly Breakdown — <span id="hourly-date-label">—</span></h2>
    <div class="chart-card">
      <div class="chart-header">
        <button class="back-link" onclick="hideHourly()">← Back to week</button>
      </div>
      <div class="chart-wrap"><canvas id="chart-hourly"></canvas></div>
    </div>
  </section>

  <!-- Model Breakdown Table -->
  <section>
    <h2>Breakdown by Model — Last 30 Days</h2>
    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th>Provider</th>
            <th>Model</th>
            <th>Real Tokens</th>
            <th>Input</th>
            <th>Output</th>
            <th>Cache Read</th>
            <th>Requests</th>
            <th>Est. Cost (USD)</th>
          </tr>
        </thead>
        <tbody id="model-table-body">
          <tr><td colspan="8" class="text" style="color:var(--text-dim);padding:20px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Provider Status -->
  <section>
    <h2>Provider Status</h2>
    <div class="provider-grid" id="provider-grid">Loading…</div>
  </section>

</main>

<div id="toast"></div>

<script>
/* ── Utilities ──────────────────────────────────────────────────────────── */
const fmt = n => n == null ? '—' : Number(n).toLocaleString('en-US');
const fmtK = n => {
  if (n == null) return '—';
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
  if (n >= 1_000)     return (n / 1_000).toFixed(1) + 'K';
  return String(n);
};
const fmtCost = v => v == null ? '—' : '$' + Number(v).toFixed(4);

/* ── Chart defaults ─────────────────────────────────────────────────────── */
Chart.defaults.color = '#8b949e';
Chart.defaults.borderColor = '#30363d';
Chart.defaults.font.family = 'inherit';

let chartWeekly = null;
let chartHourly = null;

/* ── Model color palette (consistent by model name across week changes) ─── */
const MODEL_COLORS = [
  '#4e9af1', // blue
  '#f17c4e', // orange
  '#4ef1a0', // green
  '#f1e44e', // yellow
  '#c04ef1', // purple
  '#f14e7c', // red
];
// Map model name → color (assigned on first encounter, stable across calls)
const modelColorMap = {};
let modelColorIdx = 0;
function colorForModel(model) {
  if (!(model in modelColorMap)) {
    modelColorMap[model] = MODEL_COLORS[modelColorIdx % MODEL_COLORS.length];
    modelColorIdx++;
  }
  return modelColorMap[model];
}

/* ── Week state ─────────────────────────────────────────────────────────── */
let currentWeekOffset = 0;
let currentWeekData = null;   // cached days array for label lookup

function weekLabel(weekStart) {
  const d = new Date(weekStart + 'T00:00:00Z');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
}

function dayLabel(dateStr) {
  const d = new Date(dateStr + 'T00:00:00Z');
  const day = d.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
  const num = d.getUTCDate();
  return `${day} ${num}`;
}

function buildWeeklyChart(weekData) {
  currentWeekData = weekData.days;

  const labels = weekData.days.map(d => dayLabel(d.date));

  // Update nav label
  document.getElementById('week-label').textContent =
    'Week of ' + weekLabel(weekData.week_start);

  // Disable next-week button if already on current week
  document.getElementById('btn-next-week').disabled = currentWeekOffset >= 0;

  // Pre-assign colors to all models now so they are consistent
  weekData.models.forEach(m => colorForModel(m));

  const datasets = weekData.models.map(model => {
    const color = colorForModel(model);
    return {
      label: model,
      data: weekData.days.map(d => (d.by_model && d.by_model[model]) || 0),
      backgroundColor: color + 'aa',
      borderColor: color,
      borderWidth: 1,
      borderRadius: 2,
    };
  });

  if (chartWeekly) chartWeekly.destroy();
  chartWeekly = new Chart(document.getElementById('chart-weekly'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: { boxWidth: 12, font: { size: 11 }, padding: 10 }
        }
      },
      scales: {
        x: { stacked: true, ticks: { font: { size: 11 } } },
        y: { stacked: true, ticks: { callback: v => fmtK(v) } }
      },
      onClick: (evt, elements) => {
        if (!elements.length) return;
        const idx = elements[0].index;
        const day = weekData.days[idx];
        loadHourly(day.date);
      }
    }
  });
}

async function navigateWeek(delta) {
  currentWeekOffset += delta;
  await loadWeekly(currentWeekOffset);
}

/* ── Hourly chart ───────────────────────────────────────────────────────── */
async function loadHourly(dateStr) {
  const data = await fetch('/api/usage/hourly?date=' + dateStr).then(r => r.json());

  // Update title
  const d = new Date(dateStr + 'T00:00:00Z');
  const label = d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', timeZone: 'UTC' });
  document.getElementById('hourly-date-label').textContent = label;
  document.getElementById('hourly-section').style.display = 'block';

  const labels = data.hours.map(h => String(h.hour).padStart(2, '0') + 'h');
  const values = data.hours.map(h => h.real_tokens);

  if (chartHourly) chartHourly.destroy();
  chartHourly = new Chart(document.getElementById('chart-hourly'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Real Tokens',
        data: values,
        backgroundColor: 'rgba(188,140,255,.55)',
        borderColor: '#bc8cff',
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { font: { size: 11 } } },
        y: { ticks: { callback: v => fmtK(v) } }
      }
    }
  });

  // Scroll to hourly section
  document.getElementById('hourly-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideHourly() {
  document.getElementById('hourly-section').style.display = 'none';
  if (chartHourly) { chartHourly.destroy(); chartHourly = null; }
}

/* ── Data loaders ───────────────────────────────────────────────────────── */
async function loadSummary() {
  const r = await fetch('/api/usage/summary').then(r => r.json());
  const s7 = r.by_period.last_7d;
  const s30 = r.by_period.last_30d;

  document.getElementById('c-real-7d').textContent  = fmtK(s7.real_tokens);
  document.getElementById('c-req-7d').textContent   = fmt(s7.requests);
  document.getElementById('c-cost-30d').textContent = fmtCost(r.estimated_cost_usd);

  // Cache is a 30d total from summary; show proportionally is tricky — use total
  document.getElementById('c-cache-7d').textContent = fmtK(r.total_cache_tokens);

  return r;
}

async function loadWeekly(offset) {
  const data = await fetch('/api/usage/weekly-by-model?week_offset=' + offset).then(r => r.json());
  buildWeeklyChart(data);
}

async function loadModelTable() {
  const data = await fetch('/api/usage/by-model').then(r => r.json());
  const tbody = document.getElementById('model-table-body');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="text" style="color:var(--text-dim);padding:20px">No data yet — run a sync.</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(d => `
    <tr>
      <td class="text">${d.provider}</td>
      <td class="text">${d.model}</td>
      <td>${fmt(d.real_tokens)}</td>
      <td>${fmt(d.input_tokens)}</td>
      <td>${fmt(d.output_tokens)}</td>
      <td>${fmt(d.cache_read_tokens)}</td>
      <td>${fmt(d.request_count)}</td>
      <td>${fmtCost(d.estimated_cost_usd)}</td>
    </tr>`).join('');
}

async function loadProviders() {
  const data = await fetch('/api/providers').then(r => r.json());
  const grid = document.getElementById('provider-grid');
  grid.innerHTML = data.map(p => {
    const isGemini = p.name === 'google';
    const badge = isGemini
      ? `<div style="text-align:right">
           <span class="badge badge-nocapture">Not captured</span>
           <div class="provider-note">Gemini is used for heartbeats only — heartbeat calls are not recorded in session files.</div>
         </div>`
      : `<span class="badge ${p.is_configured ? 'badge-cfg' : 'badge-nocfg'}">
           ${p.is_configured ? 'Configured' : 'Not configured'}
         </span>`;
    return `
    <div class="provider-card">
      <div>
        <div class="provider-name">${p.display_name}</div>
        <div class="provider-method">${p.method}</div>
      </div>
      ${badge}
    </div>`;
  }).join('');
}

async function loadSyncLog() {
  const data = await fetch('/api/sync/log').then(r => r.json());
  if (data[0]) {
    document.getElementById('last-sync').textContent = 'Last sync: ' + data[0].synced_at;
  }
}

/* ── Sync trigger ───────────────────────────────────────────────────────── */
async function triggerSync() {
  const btn = document.getElementById('sync-btn');
  btn.disabled = true;
  btn.textContent = '↻ Syncing…';
  try {
    const r = await fetch('/api/sync', { method: 'POST' }).then(r => r.json());
    showToast(r.message, 'ok');
    await loadAll();
  } catch (e) {
    showToast('Sync failed: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = '↻ Sync Now';
  }
}

/* ── Toast ──────────────────────────────────────────────────────────────── */
let toastTimer;
function showToast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 4000);
}

/* ── Boot ───────────────────────────────────────────────────────────────── */
async function loadAll() {
  currentWeekOffset = 0;
  await Promise.all([
    loadSummary(),
    loadWeekly(0),
    loadModelTable(),
    loadProviders(),
    loadSyncLog(),
  ]);
}

loadAll();
</script>
</body>
</html>
