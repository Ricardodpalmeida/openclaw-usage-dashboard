services:
  openclaw-usage:
    build: .
    container_name: openclaw-usage
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY}
      - OPENCLAW_SESSIONS_PATH=/openclaw-sessions
      - SYNC_INTERVAL_HOURS=6
      - OPENCLAW_GATEWAY_URL=http://host.docker.internal:18789
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - WHATSAPP_ALERT_TO=+351910298749
    volumes:
      - ./data:/app/data                                           # SQLite DB persistence
      - /home/ric/.openclaw/agents/main/sessions:/openclaw-sessions:ro  # Read-only session access
    ports:
      - "8001:8000"
    networks:
      - pacheco-net

networks:
  pacheco-net:
    external: true
    name: pacheco-lab_pacheco-net

# ─────────────────────────────────────────────────────────────────────────────
# Integration with pacheco-lab
# ─────────────────────────────────────────────────────────────────────────────
# This is a standalone stack. It connects to pacheco-net so Caddy can route
# to it without being part of the main docker-compose.yml.
#
# Caddyfile entry (/opt/pacheco-lab/Caddyfile):
#   http://usage.ricbits.cc {
#       reverse_proxy openclaw-usage:8000
#   }
#
# Cloudflare Zero Trust → Networks → Connectors → pacheco-lab → Public Hostnames:
#   usage.ricbits.cc → http://caddy:80
#
# Cloudflare Access: add usage.ricbits.cc to the existing policy.
#
# Deploy:
#   cd /home/ric/projects/20260218_OpenClaw_Usage
#   cp .env.example .env   # fill in keys from ~/.openclaw/.env
#   docker compose up -d
#   # then reload Caddy in the pacheco-lab stack:
#   docker exec caddy caddy reload --config /etc/caddy/Caddyfile
